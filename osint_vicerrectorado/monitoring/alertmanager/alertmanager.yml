# AlertManager Configuration - Sistema OSINT EMI Bolivia
# Sprint 6: Hardening y Automatizaci贸n

global:
  # Configuraci贸n de resoluci贸n de alertas
  resolve_timeout: 5m
  
  # Configuraci贸n de SMTP (para notificaciones por email)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertas@emi.edu.bo'
  smtp_auth_username: ''
  smtp_auth_password: ''
  smtp_require_tls: true

# Configuraci贸n de templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Configuraci贸n de rutas
route:
  # Receptor por defecto
  receiver: 'osint-team'
  
  # Agrupar alertas similares
  group_by: ['alertname', 'severity', 'scraper_name']
  
  # Tiempo de espera antes de enviar el primer grupo
  group_wait: 30s
  
  # Tiempo entre env铆os del mismo grupo
  group_interval: 5m
  
  # Tiempo antes de repetir una notificaci贸n
  repeat_interval: 4h
  
  # Rutas espec铆ficas
  routes:
    # Alertas cr铆ticas - enviar inmediatamente
    - match:
        severity: critical
      receiver: 'osint-critical'
      group_wait: 10s
      repeat_interval: 1h
    
    # Alertas de scrapers
    - match:
        team: osint
      receiver: 'osint-team'
      routes:
        - match:
            alertname: CircuitBreakerOpen
          receiver: 'osint-team'
          repeat_interval: 30m
    
    # Alertas de infraestructura
    - match:
        team: infra
      receiver: 'infra-team'

# Configuraci贸n de receptores
receivers:
  # Receptor por defecto
  - name: 'osint-team'
    # Email
    email_configs:
      - to: 'osint-team@emi.edu.bo'
        send_resolved: true
        headers:
          subject: '[OSINT EMI] {{ .Status | toUpper }} - {{ .CommonAnnotations.summary }}'
    
    # Webhook (para integraci贸n con Slack, Discord, etc.)
    webhook_configs:
      - url: 'http://api:5000/api/v1/alerts/webhook'
        send_resolved: true

  # Receptor para alertas cr铆ticas
  - name: 'osint-critical'
    email_configs:
      - to: 'osint-critical@emi.edu.bo,admin@emi.edu.bo'
        send_resolved: true
        headers:
          subject: ' [CRTICO] {{ .CommonAnnotations.summary }}'
    webhook_configs:
      - url: 'http://api:5000/api/v1/alerts/webhook/critical'
        send_resolved: true

  # Receptor para equipo de infraestructura
  - name: 'infra-team'
    email_configs:
      - to: 'infra@emi.edu.bo'
        send_resolved: true
        headers:
          subject: '[INFRA] {{ .Status | toUpper }} - {{ .CommonAnnotations.summary }}'

# Configuraci贸n de inhibiciones
# (Previene env铆o de alertas menos severas cuando hay una cr铆tica)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'scraper_name']
  
  - source_match:
      alertname: 'ScraperDown'
    target_match_re:
      alertname: 'Scraper.*'
    equal: ['scraper_name']
